<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>梗枋 & 烏石漁港 動態水質圖示範</title>

    <!-- ① TGOS MAP API-Lite（內政部提供的 AppID / APIKey） -->
    <script type="text/javascript"
        src="https://api.tgos.tw/TGOS_API/tgos?ver=2&AppID=x+JLVSx85Lk=&APIKey=in8W74q0ogpcfW/STwicK8D5QwCdddJf05/7nb+OtDh8R99YN3T0LurV4xato3TpL/fOfylvJ9Wv/khZEsXEWxsBmg+GEj4AuokiNXCh14Rei21U5GtJpIkO++Mq3AguFK/ISDEWn4hMzqgrkxNe1Q=="
        charset="utf-8">
    </script>

    <!-- ② Chart.js（用來畫動態折線圖） -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { margin: 0; }
        #MapDiv {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 1000px;   /* 地圖加大 */
            height: 650px;   /* 地圖加大 */
            border: 1px solid #333;
        }
    </style>

    <script type="text/javascript">
        var map;          // TGOS 地圖物件
        var gfChart = null;  // 梗枋 pH 圖表
        var wsChart = null;  // 烏石 pH 圖表

        // --- 初始化地圖 ---
        function InitMap() {
            var mapDiv = document.getElementById("MapDiv");

            var mapOptions = {
                scaleControl: false,
                navigationControl: true,
                navigationControlOptions: {
                    controlPosition: TGOS.TGControlPosition.TOP_LEFT,
                    navigationControlStyle: TGOS.TGNavigationControlStyle.SMALL
                },
                mapTypeControl: false
            };

            // 梗枋漁港 TWD97 座標（X, Y）
            var gengfangPoint = new TGOS.TGPoint(337898.412, 2755463.869);

            // 烏石漁港 TWD97 座標（X, Y）
            var wushiPoint   = new TGOS.TGPoint(334485.346, 2751416.022);

            // 地圖初始中心取兩港口中間附近（粗略平均）
            var centerX = (337898.412 + 334485.346) / 2;
            var centerY = (2755463.869 + 2751416.022) / 2;
            var centerPoint = new TGOS.TGPoint(centerX, centerY);

            // 建立 TGOS 地圖（使用 TWD97 EPSG3826）
            map = new TGOS.TGOnlineMap(mapDiv, TGOS.TGCoordSys.EPSG3826, mapOptions);
            map.setZoom(11);              // 比 12 再拉遠一點，方便一次看到兩個港
            map.setCenter(centerPoint);

            // 標記圖示設定
            var iconUrl = "https://api.tgos.tw/TGOS_API/images/marker2.png";
            var markerImg = new TGOS.TGImage(
                iconUrl,
                new TGOS.TGSize(38, 33),
                new TGOS.TGPoint(0, 0),
                new TGOS.TGPoint(10, 33)
            );

            // --- 梗枋漁港 Marker + InfoWindow ---
            var gfMarker = new TGOS.TGMarker(map, gengfangPoint, "梗枋漁港", markerImg);

            var gfHtml =
                "<b>梗枋漁港 pH 時序圖（示範）</b><br>" +
                "<small>滑鼠移到點上可看數值</small><br>" +
                "<div style='width:320px;height:220px;'>" +
                "  <canvas id='gfChartCanvas' width='320' height='200'></canvas>" +
                "</div>";

            var gfInfoWindow = new TGOS.TGInfoWindow(gfHtml, gengfangPoint, {
                maxWidth: 360,
                pixelOffset: new TGOS.TGSize(5, -30),
                zIndex: 99
            });

            TGOS.TGEvent.addListener(gfMarker, "click", function () {
                gfInfoWindow.open(map);
                // 等 InfoWindow DOM 建好後再畫圖
                setTimeout(drawGengfangChart, 200);
            });

            // --- 烏石漁港 Marker + InfoWindow ---
            var wsMarker = new TGOS.TGMarker(map, wushiPoint, "烏石漁港", markerImg);

            var wsHtml =
                "<b>烏石漁港 pH 時序圖（示範）</b><br>" +
                "<small>滑鼠移到點上可看數值</small><br>" +
                "<div style='width:320px;height:220px;'>" +
                "  <canvas id='wsChartCanvas' width='320' height='200'></canvas>" +
                "</div>";

            var wsInfoWindow = new TGOS.TGInfoWindow(wsHtml, wushiPoint, {
                maxWidth: 360,
                pixelOffset: new TGOS.TGSize(5, -30),
                zIndex: 99
            });

            TGOS.TGEvent.addListener(wsMarker, "click", function () {
                wsInfoWindow.open(map);
                setTimeout(drawWushiChart, 200);
            });
        }

        // --- 梗枋漁港：pH 動態折線圖 ---
        function drawGengfangChart() {
            var canvas = document.getElementById('gfChartCanvas');
            if (!canvas) return;

            var ctx = canvas.getContext('2d');

            if (gfChart !== null) {
                gfChart.destroy();
            }

            // 這裡用假資料：2024 年 1–12 月 pH
            var labels = ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
            var phData = [7.9, 8.0, 7.8, 7.7, 7.6, 7.5, 7.6, 7.7, 7.8, 7.9, 8.0, 7.9];

            gfChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'pH 值（梗枋）',
                        data: phData,
                        tension: 0.3,
                        fill: false,
                        borderWidth: 2,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: false,
                    scales: {
                        y: {
                            suggestedMin: 7.0,
                            suggestedMax: 8.5,
                            title: {
                                display: true,
                                text: 'pH'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '月份'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: true },
                        tooltip: { enabled: true }
                    }
                }
            });
        }

        // --- 烏石漁港：pH 動態折線圖 ---
        function drawWushiChart() {
            var canvas = document.getElementById('wsChartCanvas');
            if (!canvas) return;

            var ctx = canvas.getContext('2d');

            if (wsChart !== null) {
                wsChart.destroy();
            }

            // 這裡也用一組假資料：稍微跟梗枋不同
            var labels = ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
            var phData = [7.8, 7.9, 7.7, 7.6, 7.5, 7.4, 7.5, 7.6, 7.7, 7.8, 7.9, 7.8];

            wsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'pH 值（烏石）',
                        data: phData,
                        tension: 0.3,
                        fill: false,
                        borderWidth: 2,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: false,
                    scales: {
                        y: {
                            suggestedMin: 7.0,
                            suggestedMax: 8.5,
                            title: {
                                display: true,
                                text: 'pH'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '月份'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: true },
                        tooltip: { enabled: true }
                    }
                }
            });
        }
    </script>
</head>

<body onload="InitMap();">
    <div id="MapDiv"></div>
</body>
</html>